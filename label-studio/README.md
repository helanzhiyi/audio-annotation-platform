# Label Studio Deployment Guide

This directory contains the Label Studio setup with PostgreSQL backend for the Audio Transcription System.

## Quick Start

### First-Time Setup

1. **Run the setup script** (REQUIRED before first start):
   ```bash
   cd label-studio
   ./setup.sh
   ```

   The setup script will:
   - Auto-detect your public IP (for EC2/cloud deployments)
   - Generate secure passwords and secret keys
   - Create a `.env` file with proper configuration
   - Configure `LABEL_STUDIO_HOST` for correct CSS/JS loading

2. **Create the Docker network** (one-time):
   ```bash
   docker network create label-studio-net
   ```

3. **Start the services**:
   ```bash
   docker-compose up -d
   ```

4. **Check the logs**:
   ```bash
   docker-compose logs -f
   ```

5. **Access Label Studio**:
   - The URL will be shown during setup
   - Default: http://YOUR_PUBLIC_IP:8080
   - Create your admin account on first access

### Subsequent Starts

After initial setup, you only need:
```bash
docker-compose up -d      # Start services
docker-compose logs -f    # View logs
docker-compose down       # Stop services
```

## Configuration Files

- `.env.example` - Template for environment variables (tracked in git)
- `.env` - Your actual configuration (NOT tracked in git, generated by setup.sh)
- `docker-compose.yml` - Docker service definitions
- `setup.sh` - Interactive setup script

## Important Environment Variables

### `LABEL_STUDIO_HOST` (CRITICAL)
This variable controls how Label Studio generates URLs for static assets (CSS, JS).

**Must be set to:**
- Your EC2 public IP: `http://3.123.45.67:8080`
- Your domain name: `http://your-domain.com:8080`
- For local dev: `http://localhost:8080`

**Why it matters:**
If not set correctly, Label Studio will use `localhost` in URLs, causing CSS/JS to fail when accessing from outside.

### Other Variables
- `POSTGRES_PASSWORD` - Database password (auto-generated)
- `SECRET_KEY` - Django secret key (auto-generated)
- `POSTGRES_DB` - Database name (default: labelstudio)
- `POSTGRES_USER` - Database user (default: labelstudio)

## Directory Structure

```
label-studio/
├── README.md              # This file
├── setup.sh              # Setup script (run this first!)
├── .env.example          # Template (committed to git)
├── .env                  # Your config (ignored by git)
├── docker-compose.yml    # Service definitions
├── data/                 # Label Studio data (created on start)
├── media/                # Audio files storage (created on start)
├── export/               # Export directory (created on start)
└── backups/              # Database backups (created on start)
```

## Troubleshooting

### CSS/JS Not Loading

**Symptom:** Label Studio interface loads but has no styling, looks broken

**Cause:** `LABEL_STUDIO_HOST` is not set correctly or is set to `localhost`

**Fix:**
1. Stop the services: `docker-compose down`
2. Run setup again: `./setup.sh`
3. Or manually edit `.env` and set `LABEL_STUDIO_HOST` to your public IP
4. Restart: `docker-compose up -d`

### Cannot Connect to Database

**Symptom:** Label Studio fails to start with database errors

**Cause:** PostgreSQL password not set or containers can't communicate

**Fix:**
1. Ensure `.env` file exists: `ls -la .env`
2. Ensure network exists: `docker network ls | grep label-studio-net`
3. Create network if missing: `docker network create label-studio-net`
4. Check postgres health: `docker-compose ps`

### Port Already in Use

**Symptom:** Error binding to port 8080

**Fix:**
```bash
# Check what's using port 8080
sudo lsof -i :8080

# Stop the conflicting service or change the port in docker-compose.yml
```

### Permission Issues

**Symptom:** Cannot write to data/media/export directories

**Fix:**
```bash
# The containers run as user 1001:1001
# Ensure directories are writable
sudo chown -R 1001:1001 data/ media/ export/
```

## Reconfiguration

If you need to change your configuration (e.g., move to a different server):

1. Run setup again: `./setup.sh`
2. Choose to reconfigure when prompted
3. Old config will be backed up as `.env.backup.TIMESTAMP`
4. Restart services: `docker-compose restart`

## Production Deployment Checklist

- [ ] Run `./setup.sh` and configure with correct public IP/domain
- [ ] Ensure port 8080 is open in security groups/firewall
- [ ] Create Docker network: `docker network create label-studio-net`
- [ ] Start services: `docker-compose up -d`
- [ ] Verify CSS/JS loads correctly by accessing the URL
- [ ] Create admin account
- [ ] Set up regular backups of PostgreSQL data
- [ ] Configure HTTPS/reverse proxy if needed (recommended for production)

## Security Notes

- `.env` file contains sensitive passwords - NEVER commit to git
- Default setup uses HTTP - consider setting up HTTPS for production
- PostgreSQL is bound to 127.0.0.1 only (not exposed externally)
- Generated passwords are 25 characters with high entropy
- Secret keys are 50 characters with high entropy

## Integration with Middleware

The middleware service (ls-middleware) connects to Label Studio:
- Label Studio API: `http://localhost:8080` (internal)
- Audio files: Served from `./media/` directory
- Middleware authenticates using Label Studio API token

See middleware documentation for integration details.

## Backup and Restore

### Manual Database Backup
```bash
# Backup
docker exec ls-postgres pg_dump -U labelstudio labelstudio > backups/backup_$(date +%Y%m%d_%H%M%S).sql

# Restore
docker exec -i ls-postgres psql -U labelstudio labelstudio < backups/backup_YYYYMMDD_HHMMSS.sql
```

### Full Data Backup
```bash
# Backup everything
tar -czf labelstudio_backup_$(date +%Y%m%d).tar.gz data/ media/ export/ .env

# Restore
tar -xzf labelstudio_backup_YYYYMMDD.tar.gz
```

## Support

For issues specific to:
- Label Studio itself: https://github.com/heartexlabs/label-studio
- This deployment setup: Check middleware documentation or create an issue
- AWS/EC2 configuration: Refer to AWS documentation
